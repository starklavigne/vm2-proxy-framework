# ğŸ›¡ï¸ VM2 + Proxy Reverse Engineering Framework

è¿™æ˜¯ä¸€ä¸ªåŸºäº **Node.js**ã€**VM2** å’Œ **ES6 Proxy** æ„å»ºçš„é«˜å†…èšã€ä½è€¦åˆçš„ JavaScript è¡¥ç¯å¢ƒæ¡†æ¶ã€‚

è¯¥æ¡†æ¶ä¸“ä¸º JS é€†å‘å·¥ç¨‹ï¼ˆReverse Engineeringï¼‰è®¾è®¡ï¼Œæ—¨åœ¨æä¾›ä¸€ä¸ªçº¯å‡€ã€å¯ç›‘æ§ã€æ˜“æ‰©å±•çš„æ²™ç®±ç¯å¢ƒï¼Œç”¨äºåˆ†æå’Œè¿è¡Œé«˜å¼ºåº¦çš„æ··æ·†ä»£ç ï¼ˆå¦‚
Cloudflare Turnstile, Akamai, Datadome ç­‰ï¼‰ã€‚

## ğŸŒŸ è®¾è®¡ç†å¿µ (Design Philosophy)

æœ¬æ¡†æ¶ä¸¥æ ¼éµå¾ª **â€œæä½è€¦åˆ (Loose Coupling)â€** çš„è®¾è®¡åŸåˆ™ï¼Œå°†ç³»ç»Ÿæ‹†åˆ†ä¸ºäº”ä¸ªç‹¬ç«‹çš„å±‚çº§ï¼š

1. **æ•°æ®å±‚ (Config)**ï¼šçº¯ç²¹çš„ JSON/Object é…ç½®ï¼Œç®¡ç† UserAgentã€å±å¹•åˆ†è¾¨ç‡ç­‰æŒ‡çº¹æ•°æ®ã€‚
2. **æ‹¦æˆªå±‚ (Interceptor)**ï¼šé€šç”¨çš„ Proxy å·¥å‚ï¼Œè´Ÿè´£â€œç›‘æ§â€ã€â€œæ—¥å¿—â€å’Œâ€œé€’å½’ä»£ç†â€ï¼Œä¸åŒ…å«å…·ä½“çš„ä¸šåŠ¡é€»è¾‘ã€‚
3. **ç¯å¢ƒå±‚ (Environment)**ï¼šå…·ä½“çš„æµè§ˆå™¨å¯¹è±¡æ¨¡æ‹Ÿï¼ˆWindow, Navigator, Document ç­‰ï¼‰ï¼Œåªå…³æ³¨æ¨¡æ‹Ÿå®ç°ã€‚
4. **æ‰§è¡Œå±‚ (Runner)**ï¼šå°è£… VM2 æ²™ç®±ï¼Œæä¾›çº¯å‡€çš„ä»£ç æ‰§è¡Œå®¹å™¨ã€‚
5. **ç»„è£…å±‚ (Main)**ï¼šå”¯ä¸€çš„è€¦åˆç‚¹ï¼Œè´Ÿè´£å°†ä¸Šè¿°ç»„ä»¶ç»„è£…å¹¶å¯åŠ¨ã€‚

## ğŸ“‚ ç›®å½•ç»“æ„ (Directory Structure)

```text
vm2-proxy-framework/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ config/             # [æ•°æ®å±‚] æµè§ˆå™¨æŒ‡çº¹é…ç½®
â”‚   â”‚   â””â”€â”€ browserProfile.js
â”‚   â”œâ”€â”€ core/               # [æ‹¦æˆªå±‚] Proxy æ ¸å¿ƒé€»è¾‘
â”‚   â”‚   â””â”€â”€ ProxyFactory.js
â”‚   â”œâ”€â”€ env/                # [ç¯å¢ƒå±‚] å…·ä½“çš„æµè§ˆå™¨å¯¹è±¡æ¨¡æ‹Ÿ
â”‚   â”‚   â”œâ”€â”€ Window.js       # å…¨å±€å¯¹è±¡å…¥å£
â”‚   â”‚   â”œâ”€â”€ Navigator.js    # å¯¼èˆªå¯¹è±¡
â”‚   â”‚   â”œâ”€â”€ Document.js     # æ–‡æ¡£å¯¹è±¡
â”‚   â”‚   â””â”€â”€ index.js        # ç»Ÿä¸€å¯¼å‡º
â”‚   â””â”€â”€ runner/             # [æ‰§è¡Œå±‚] VM2 æ²™ç®±å°è£…
â”‚       â””â”€â”€ VMRunner.js
â”œâ”€â”€ target/                 # å­˜æ”¾ç›®æ ‡æ··æ·†ä»£ç 
â”‚   â””â”€â”€ target.js
â”œâ”€â”€ main.js                 # [ç»„è£…å±‚] ç¨‹åºå…¥å£
â””â”€â”€ README.md               # è¯´æ˜æ–‡æ¡£
```

## ğŸš€ å¿«é€Ÿå¼€å§‹ (Quick Start)

### 1. å®‰è£…ä¾èµ–

ç¡®ä¿ä½ çš„ç¯å¢ƒä¸­å·²å®‰è£… Node.jsã€‚

```text
Bash
# åˆå§‹åŒ–é¡¹ç›®
npm init -y

# å®‰è£…æ ¸å¿ƒä¾èµ– vm2
npm install vm2
```

### 2. å‡†å¤‡ç›®æ ‡ä»£ç 

å°†ä½ éœ€è¦åˆ†æçš„æ··æ·†ä»£ç ï¼ˆæˆ–æµ‹è¯•ä»£ç ï¼‰æ”¾å…¥ target/target.jsã€‚

### 3. è¿è¡Œæ¡†æ¶

```text
Bash
node main.js
```

ä½ å°†åœ¨æ§åˆ¶å°çœ‹åˆ°å¦‚ä¸‹æ ¼å¼çš„æ—¥å¿—ï¼Œè¿™è¡¨ç¤ºâ€œç›‘æ§æ¢å¤´â€å·²ç»å¼€å§‹å·¥ä½œï¼š

```text
Plaintext
>>> å¼€å§‹æ‰§è¡Œç›®æ ‡ä»£ç : .../target/target.js >>>

[è¯»] window.navigator -> [object Navigator]
[è¯»] window.navigator.userAgent -> Mozilla/5.0...
[!] è­¦å‘Šï¼šwindow.screen æœªå®šä¹‰ï¼Œå¯èƒ½éœ€è¦è¡¥ç¯å¢ƒï¼
```

## ğŸ› ï¸ è¡¥ç¯å¢ƒå·¥ä½œæµ (Workflow)

é€†å‘å·¥ç¨‹çš„æ ¸å¿ƒåœ¨äº**â€œç¼ºä»€ä¹ˆè¡¥ä»€ä¹ˆâ€**ã€‚åˆ©ç”¨æœ¬æ¡†æ¶çš„ Proxy è‡ªåŠ¨ç›‘æµ‹æœºåˆ¶ï¼Œä½ å¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤é«˜æ•ˆå·¥ä½œï¼š

è¿è¡Œä»£ç ï¼šæ‰§è¡Œ node main.jsã€‚

1. è§‚å¯Ÿæ—¥å¿—ï¼šå¯»æ‰¾å¸¦æœ‰ [!] è­¦å‘Š çš„æ—¥å¿—æ¡ç›®ï¼Œæˆ–è§‚å¯Ÿä»£ç åœ¨å“ªé‡ŒæŠ¥é”™/åœæ­¢ã€‚
2. ç¼–å†™å®ç°ï¼šåœ¨ src/env/ ç›®å½•ä¸‹åˆ›å»ºç¼ºå¤±çš„å¯¹è±¡æ–‡ä»¶ï¼ˆä¾‹å¦‚ Screen.jsï¼‰ã€‚
3. æ³¨å…¥ç¯å¢ƒï¼šåœ¨ src/env/Window.js ä¸­å¼•å…¥å¹¶å®ä¾‹åŒ–è¯¥å¯¹è±¡ã€‚
4. é‡å¤æ­¥éª¤ï¼šå†æ¬¡è¿è¡Œï¼Œç›´åˆ°ä»£ç è·‘é€šå¹¶ç”Ÿæˆé¢„æœŸçš„ Tokenã€‚

## ğŸ§© æ‰©å±•æŒ‡å— (Extension Guide)

åœºæ™¯ï¼šä»£ç æŠ¥é”™ screen is not defined
æ­¥éª¤ 1ï¼šåˆ›å»º src/env/Screen.js

```text
JavaScript
class Screen {
    constructor(profile) {
        this.width = profile.screenWidth;
        this.height = profile.screenHeight;
        this.availWidth = profile.screenWidth;
        this.availHeight = profile.screenHeight;
        this.colorDepth = 24;
    }
}
module.exports = Screen;
```

æ­¥éª¤ 2ï¼šåœ¨ src/env/Window.js ä¸­æ³¨å†Œ

```text
JavaScript
const Navigator = require('./Navigator');
const Document = require('./Document');
const Screen = require('./Screen'); // <--- å¼•å…¥

class Window {
    constructor(profile) {
        this.navigator = new Navigator(profile);
        this.document = new Document(profile);
        this.screen = new Screen(profile); // <--- å®ä¾‹åŒ–
        
        // ... å…¶ä»–ä»£ç 
    }
}
module.exports = Window;
```

å¾—ç›Šäº ProxyFactory çš„é€’å½’ä»£ç†æœºåˆ¶ï¼Œä½ ä¸éœ€è¦æ‰‹åŠ¨ä¸º Screen åˆ›å»º Proxyã€‚åªè¦ window è¢«ä»£ç†äº†ï¼Œé€šè¿‡ window.screen è·å–åˆ°çš„å¯¹è±¡ä¼šè‡ªåŠ¨è¢«
Proxy åŒ…è£¹å¹¶å…·å¤‡ç›‘æ§èƒ½åŠ›ã€‚

## âš™ï¸ æ ¸å¿ƒç»„ä»¶è¯´æ˜

ProxyFactory (src/core/ProxyFactory.js)

```text

- åŠŸèƒ½ï¼šä¸ºå¯¹è±¡ç©¿ä¸Šâ€œç›‘æ§è£…ç”²â€ã€‚
- ç‰¹æ€§ï¼š
    - è‡ªåŠ¨é€’å½’ï¼šå½“è·å–å±æ€§å€¼ä¸ºå¯¹è±¡æ—¶ï¼Œè‡ªåŠ¨ä¸ºå…¶åˆ›å»ºå­ Proxyã€‚
    - æ–¹ä½æ‹¦æˆªï¼šæ”¯æŒ Get, Set, Apply (å‡½æ•°è°ƒç”¨), Construct (new è°ƒç”¨)ã€‚
    - æ ¼å¼åŒ–è¾“å‡ºï¼šå°†å¤æ‚çš„å¯¹è±¡è¾“å‡ºä¸ºå¯è¯»çš„å­—ç¬¦ä¸²ã€‚
```

VMRunner (src/runner/VMRunner.js)

```text

- åŠŸèƒ½ï¼šæä¾›å¹²å‡€çš„æ‰§è¡Œâ€œæˆ¿é—´â€ã€‚
- ç‰¹æ€§ï¼š
    - ä½¿ç”¨ vm2 éš”ç¦»å®¿ä¸»ç¯å¢ƒï¼ˆNode.js çš„ process, fs ç­‰ï¼‰ã€‚
    - setContext æ–¹æ³•å°†ä¼ªé€ çš„ window å¯¹è±¡å¹³é“ºåˆ°æ²™ç®±å…¨å±€ã€‚
```

## âš ï¸ å…è´£å£°æ˜ (Disclaimer)

1. VM2 å®‰å…¨æ€§ï¼švm2 åº“å­˜åœ¨å·²çŸ¥çš„æ²™ç®±é€ƒé€¸æ¼æ´ï¼Œä¸”å·²åœæ­¢ç»´æŠ¤ã€‚æœ¬æ¡†æ¶ä»…ä¾›æœ¬åœ°é€†å‘åˆ†æã€ç ”ç©¶å’Œå­¦ä¹ ä½¿ç”¨ï¼Œä¸¥ç¦åœ¨ç”Ÿäº§ç¯å¢ƒæˆ–å¯¹å¤–æä¾›æœåŠ¡çš„æ¥å£ä¸­ä½¿ç”¨ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´æœåŠ¡å™¨è¢«å…¥ä¾µã€‚
2. åˆæ³•æ€§ï¼šè¯·ç¡®ä¿ä½ çš„é€†å‘å·¥ç¨‹è¡Œä¸ºç¬¦åˆå½“åœ°æ³•å¾‹æ³•è§„ï¼Œä»…ç”¨äºåˆæ³•çš„å®‰å…¨ç ”ç©¶æˆ–å…¼å®¹æ€§æµ‹è¯•ã€‚